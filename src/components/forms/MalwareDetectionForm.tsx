import { useState } from 'react'

interface MalwareDetectionFormProps {
  onSubmit: () => void
}

const MALWARE_GROUP_OPTIONS: Record<string, string[]> = {
  'Netskope File Scanner': ['Default Malware Scan'],
  Allowlist: ['File Hash Allowlist', 'File Name Allowlist', 'Certificate Allowlist'],
  Blocklist: ['File Hash Blocklist', 'File Name Blocklist', 'URL Blocklist'],
}

export default function MalwareDetectionForm({ onSubmit }: MalwareDetectionFormProps) {
  const [profileName, setProfileName] = useState('')
  const [selections, setSelections] = useState<Record<string, string[]>>({
    'Netskope File Scanner': [],
    Allowlist: [],
    Blocklist: [],
  })
  const [expandedGroup, setExpandedGroup] = useState<string | null>(null)

  const handleToggle = (group: string, value: string) => {
    setSelections(prev => {
      const current = prev[group] || []
      const isSelected = current.includes(value)
      return {
        ...prev,
        [group]: isSelected ? current.filter(v => v !== value) : [...current, value],
      }
    })
  }

  const handleSelectAll = (group: string) => {
    const options = MALWARE_GROUP_OPTIONS[group] || []
    setSelections(prev => {
      const current = prev[group] || []
      return {
        ...prev,
        [group]: current.length === options.length ? [] : [...options],
      }
    })
  }

  const handleSubmit = () => {
    if (profileName.trim()) {
      console.log('Creating malware detection profile:', { profileName, selections })
      alert(`Profile created!\nProfile Name: ${profileName}`)
      onSubmit()
    }
  }

  return (
    <div className="form-section">
      <div className="form-group">
        <label htmlFor="profile-name">Profile Name</label>
        <input
          id="profile-name"
          type="text"
          placeholder="Enter profile name"
          value={profileName}
          onChange={e => setProfileName(e.target.value)}
          className="form-input"
        />
      </div>

      {Object.entries(MALWARE_GROUP_OPTIONS).map(([group, options]) => {
        const selected = selections[group] || []
        const isExpanded = expandedGroup === group

        return (
          <fieldset key={group} className="form-fieldset">
            <legend className="form-fieldset-legend">{group}</legend>
            <button
              type="button"
              className="dropdown-checkbox-btn"
              onClick={() => setExpandedGroup(isExpanded ? null : group)}
            >
              {selected.length > 0 ? (
                <span className="dropdown-checkbox-count">{selected.length} selected</span>
              ) : (
                <span className="dropdown-checkbox-placeholder">Select</span>
              )}
              <span className={`dropdown-checkbox-arrow ${isExpanded ? 'open' : ''}`}>&#9660;</span>
            </button>
            {isExpanded && (
              <div className="dropdown-checkbox-panel">
                {group !== 'Netskope File Scanner' && (
                  <label className="dropdown-checkbox-option dropdown-checkbox-select-all">
                    <input
                      type="checkbox"
                      checked={selected.length === options.length}
                      onChange={() => handleSelectAll(group)}
                    />
                    <span>Select All ({options.length})</span>
                  </label>
                )}
                {options.map(option => (
                  <label key={option} className="dropdown-checkbox-option">
                    <input
                      type="checkbox"
                      checked={selected.includes(option)}
                      onChange={() => handleToggle(group, option)}
                    />
                    <span>{option}</span>
                  </label>
                ))}
              </div>
            )}
          </fieldset>
        )
      })}

      <button className="create-btn" onClick={handleSubmit} disabled={!profileName.trim()}>
        Create Profile
      </button>
    </div>
  )
}
